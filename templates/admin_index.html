<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员首页 - 农业轨迹分析系统</title>
    <!-- 引入 Leaflet 地图库 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
          crossorigin=""/>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2E7D32;
            --background-color: #f8f9fa;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', '微软雅黑', sans-serif;
            background-color: var(--background-color);
        }

        .admin-header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-nav {
            display: flex;
            gap: 20px;
        }

        .admin-nav a {
            color: var(--primary-color);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .admin-nav a:hover {
            background: #E8F5E9;
        }

        .admin-content {
            padding: 30px;
        }

        .admin-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .admin-card h2 {
            color: var(--secondary-color);
            margin-top: 0;
        }

        .user-list {
            list-style: none;
            padding: 0;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
        }
        
        /* 侧边导航栏 */
        .sidebar {
            width: 250px;
            height: 100vh;
            position: fixed;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 30px;
        }

        .nav-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
            color: #666;
            text-decoration: none;
            display: block;
        }

        .nav-item:hover {
            background: #E8F5E9;
            color: var(--primary-color);
        }

        .nav-item.active {
            background: #E8F5E9;
            color: var(--primary-color);
        }

        /* 地图容器 */
        .map-container {
            margin-left: 250px;
            padding: 20px;
            height: calc(100vh - 60px);
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: #f8f9fa;
        }

        /* 地图控制面板 */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-controls select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        .map-controls button {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .map-controls button:hover {
            background: var(--secondary-color);
        }

        /* 覆盖 Leaflet 默认样式 */
        .leaflet-control-attribution {
            background: rgba(255, 255, 255, 0.8) !important;
            border-radius: 4px !important;
            padding: 2px 5px !important;
        }

        /* 图层切换按钮 */
        .layer-switch {
            display: flex;
            gap: 10px;
        }

        .layer-switch button {
            flex: 1;
        }

        .layer-switch button.active {
            background: var(--secondary-color);
        }

        /* 添加数据上传区域样式 */
        .upload-area {
            border: 2px dashed #C8E6C9;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: #F1F8E9;
        }

        /* 添加用户表格样式 */
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .user-table th,
        .user-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .user-table th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        .user-table tr:hover {
            background-color: #f9f9f9;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .edit-btn {
            background: #2196F3;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.9;
        }

        /* 添加地块表格样式 */
        .field-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .field-table th,
        .field-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .field-table th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #333;
        }

        .field-table tr:hover {
            background-color: #f9f9f9;
        }

        .field-actions {
            display: flex;
            gap: 10px;
        }

        .field-management {
            margin-top: 20px;
        }
    </style>
    <!-- 引入 Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
            crossorigin=""></script>
    <script>
        // 定义自定义图标
        var customIcon = L.icon({
            iconUrl: '/static/R-C.jpg',  // 图标图片路径
            iconSize: [32, 32],          // 图标大小
            iconAnchor: [16, 16],        // 图标锚点位置
            popupAnchor: [0, -16]        // 弹出框位置
        });
    </script>
</head>
<body>
    <div class="admin-header">
        <h1>🌾 农踪分析 - 管理员首页</h1>
        <div class="admin-nav">
            <a href="{% url 'logout' %}">退出登录</a>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="nav-item active" id="dashboard-nav">📊 数据分析看板</div>
        <div class="nav-item" id="visualization-nav">🗺️ 轨迹可视化</div>
        <div class="nav-item" id="import-nav">📤 数据导入</div>
        <div class="nav-item" id="settings-nav">⚙️ 系统设置</div>
    </div>

    <!-- 管理员内容区域 -->
    <div class="admin-content" id="dashboard-content" style="margin-left: 250px; display: block;">
        <!-- 数据分析看板内容 -->
        <div class="admin-card">
            <h2>用户管理</h2>
            <div class="user-actions" style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="refreshUserList()">刷新用户列表</button>
            </div>
            <div class="user-list-container">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>用户名</th>
                            <th>邮箱</th>
                            <th>注册时间</th>
                            <th>最后登录</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="user-list">
                        <!-- 用户列表将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="admin-card">
            <h2>系统统计</h2>
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <div style="flex: 1; text-align: center; padding: 20px; background: #E8F5E9; border-radius: 8px;">
                    <h3>{{ total_fields }}</h3>
                    <p>地块总数</p>
                </div>
                <div style="flex: 1; text-align: center; padding: 20px; background: #E8F5E9; border-radius: 8px;">
                    <h3>{{ total_tracks }}</h3>
                    <p>轨迹点总数</p>
                </div>
            </div>

            <!-- 地块管理表格 -->
            <div class="field-management">
                <h3>地块管理</h3>
                <div class="field-actions" style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="refreshFieldList()">刷新地块列表</button>
                </div>
                <table class="field-table">
                    <thead>
                        <tr>
                            <th>地块名称</th>
                            <th>轨迹点数量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="field-list">
                        <!-- 地块列表将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 数据导入区域 -->
    <div class="admin-content" id="import-content" style="margin-left: 250px; display: none;">
        <div class="admin-card">
            <h2>📥 农业数据导入</h2>
            <form method="post" enctype="multipart/form-data" id="upload-form" action="{% url 'upload_csv' %}">
                {% csrf_token %}
                <div class="upload-area" onclick="document.getElementById('file-input').click()">
                    <p>点击或拖放文件到此区域</p>
                    <p>支持格式：CSV</p>
                    <input type="file" name="csv_file" id="file-input" hidden accept=".csv">
                </div>
                <button type="submit" class="btn btn-primary" style="margin-top: 15px;">开始上传</button>
            </form>
            <div id="upload-progress" style="display:none;margin-top:15px;">
                <p id="upload-status">准备上传...</p>
                <progress value="0" max="100"></progress>
            </div>
        </div>
    </div>

    <!-- 地图容器 -->
    <div class="map-container" id="map-content" style="display: none;">
        <div id="map"></div>
        <div class="map-controls">
            <select id="field-select">
                <option value="">选择地块</option>
                {% for field in fields %}
                <option value="{{ field.file_name }}">{{ field.file_name }}</option>
                {% endfor %}
            </select>
            <div class="layer-switch">
                <button id="satellite-btn" class="active">卫星图</button>
                <button id="road-btn">道路图</button>
            </div>
            <div style="margin-top: 10px;">
                <button id="load-all-btn" class="btn">加载所有轨迹</button>
            </div>
        </div>
    </div>

    <script>
        // 导航菜单点击事件
        document.getElementById('dashboard-nav').addEventListener('click', function() {
            document.getElementById('dashboard-content').style.display = 'block';
            document.getElementById('map-content').style.display = 'none';
            document.getElementById('import-content').style.display = 'none';
            
            // 更新活动状态
            this.classList.add('active');
            document.getElementById('visualization-nav').classList.remove('active');
            document.getElementById('import-nav').classList.remove('active');
            document.getElementById('settings-nav').classList.remove('active');
        });

        document.getElementById('visualization-nav').addEventListener('click', function() {
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('map-content').style.display = 'block';
            document.getElementById('import-content').style.display = 'none';
            
            // 更新活动状态
            this.classList.add('active');
            document.getElementById('dashboard-nav').classList.remove('active');
            document.getElementById('import-nav').classList.remove('active');
            document.getElementById('settings-nav').classList.remove('active');

            // 初始化地图（如果尚未初始化）
            if (!window.mapInitialized) {
                initMap();
                window.mapInitialized = true;
            }
        });

        // 为"设置"导航项添加点击事件
        document.getElementById('settings-nav').addEventListener('click', function() {
            // 跳转到系统设置页面
            window.location.href = "{% url 'admin_settings' %}";
        });

        // 为"数据导入"导航项添加点击事件
        document.getElementById('import-nav').addEventListener('click', function() {
            document.getElementById('dashboard-content').style.display = 'none';
            document.getElementById('map-content').style.display = 'none';
            document.getElementById('import-content').style.display = 'block';
            
            // 更新活动状态
            this.classList.add('active');
            document.getElementById('dashboard-nav').classList.remove('active');
            document.getElementById('visualization-nav').classList.remove('active');
            document.getElementById('settings-nav').classList.remove('active');
        });

        // 初始化地图函数
        function initMap() {
            // 初始化地图
            var map = L.map('map').setView([46.32615683, 130.6102292], 13);

            // 使用 Esri 卫星影像服务
            var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri, Maxar, Earthstar Geographics',
                maxZoom: 19
            }).addTo(map);

            // 添加道路图层
            var roadLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            });

            // 保存地图实例和图层
            window.map = map;
            window.satelliteLayer = satelliteLayer;
            window.roadLayer = roadLayer;

            // 图层切换按钮事件处理
            document.getElementById('satellite-btn').addEventListener('click', function() {
                satelliteLayer.addTo(map);
                roadLayer.remove();
                this.classList.add('active');
                document.getElementById('road-btn').classList.remove('active');
            });

            document.getElementById('road-btn').addEventListener('click', function() {
                roadLayer.addTo(map);
                satelliteLayer.remove();
                this.classList.add('active');
                document.getElementById('satellite-btn').classList.remove('active');
            });

            // 存储轨迹线的数组
            window.trackLines = [];

            // 清除所有轨迹线
            function clearAllTracks() {
                if (window.trackLines && window.trackLines.length > 0) {
                    window.trackLines.forEach(function(line) {
                        map.removeLayer(line);
                    });
                    window.trackLines = [];
                }
            }

            // 加载并显示指定地块的轨迹
            function loadTrackByField(fieldName) {
                clearAllTracks();
                
                // 获取轨迹数据
                fetch(`/api/tracks/?field_name=${fieldName}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success' && data.data.length > 0) {
                            // 创建轨迹线
                            var path = data.data.map(point => [point.latitude, point.longitude]);
                            var trackLine = L.polyline(path, {
                                color: '#FF0000',
                                weight: 3,
                                opacity: 0.7
                            }).addTo(map);
                            window.trackLines.push(trackLine);

                            // 添加起点和终点标记，使用自定义图标
                            var startMarker = L.marker(path[0], {
                                icon: customIcon,
                                title: '起点'
                            }).addTo(map);
                            
                            var endMarker = L.marker(path[path.length - 1], {
                                icon: customIcon,
                                title: '终点'
                            }).addTo(map);
                            
                            window.trackLines.push(startMarker, endMarker);

                            // 调整地图视图以显示整个轨迹
                            map.fitBounds(trackLine.getBounds());
                        } else {
                            alert('该地块没有轨迹数据');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('获取轨迹数据失败');
                    });
            }

            // 地块选择器事件处理
            document.getElementById('field-select').addEventListener('change', function(e) {
                var fieldName = e.target.value;
                if (fieldName) {
                    loadTrackByField(fieldName);
                } else {
                    clearAllTracks();
                }
            });

            // 加载所有地块轨迹
            document.getElementById('load-all-btn').addEventListener('click', function() {
                clearAllTracks();
                
                // 获取所有地块数据
                fetch('/api/fields/')
                    .then(response => response.json())
                    .then(fieldsData => {
                        if (fieldsData.status === 'success' && fieldsData.data.length > 0) {
                            // 随机生成颜色函数
                            function getRandomColor() {
                                var letters = '0123456789ABCDEF';
                                var color = '#';
                                for (var i = 0; i < 6; i++) {
                                    color += letters[Math.floor(Math.random() * 16)];
                                }
                                return color;
                            }
                            
                            // 加载每个地块的轨迹
                            var promises = fieldsData.data.map(field => {
                                return fetch(`/api/tracks/?field_name=${field.file_name}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.status === 'success' && data.data.length > 0) {
                                            var path = data.data.map(point => [point.latitude, point.longitude]);
                                            var color = getRandomColor();
                                            var trackLine = L.polyline(path, {
                                                color: color,
                                                weight: 3,
                                                opacity: 0.7
                                            }).addTo(map);
                                            
                                            // 添加地块名称标签，使用自定义图标
                                            var labelMarker = L.marker(path[Math.floor(path.length / 2)], {
                                                icon: customIcon,
                                                title: field.file_name
                                            }).addTo(map);
                                            
                                            window.trackLines.push(trackLine, labelMarker);
                                            return trackLine;
                                        }
                                        return null;
                                    });
                            });
                            
                            // 等待所有轨迹加载完成后调整地图视图
                            Promise.all(promises).then(tracks => {
                                var validTracks = tracks.filter(track => track !== null);
                                if (validTracks.length > 0) {
                                    var bounds = L.latLngBounds(validTracks.map(track => track.getBounds()));
                                    map.fitBounds(bounds);
                                }
                            });
                        } else {
                            alert('没有找到地块数据');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('获取地块数据失败');
                    });
            });

            // 初始加载页面时自动触发加载所有轨迹
            setTimeout(function() {
                document.getElementById('load-all-btn').click();
            }, 500);
        }

        // 文件上传处理
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const fileInput = document.getElementById('file-input');
            const progress = document.querySelector('#upload-progress progress');
            const status = document.getElementById('upload-status');
            
            if (!fileInput.files[0]) {
                alert('请先选择文件');
                return;
            }

            // 显示进度条
            document.getElementById('upload-progress').style.display = 'block';
            progress.value = 0;
            status.textContent = '正在上传...';

            // 创建 XMLHttpRequest 对象
            const xhr = new XMLHttpRequest();
            
            // 监听上传进度
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progress.value = percentComplete;
                }
            });

            // 监听上传完成
            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    status.textContent = '上传成功！';
                    alert(xhr.responseText);
                    // 刷新地块列表
                    refreshFieldList();
                    // 清空文件输入
                    fileInput.value = '';
                } else {
                    status.textContent = '上传失败：' + xhr.responseText;
                    alert('上传失败：' + xhr.responseText);
                }
            });

            // 监听上传错误
            xhr.addEventListener('error', function() {
                status.textContent = '上传出错，请重试';
                alert('上传出错，请重试');
            });

            // 发送请求
            xhr.open('POST', this.action, true);
            xhr.send(formData);
        });

        // 文件选择处理
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (!file.name.endsWith('.csv')) {
                    alert('请选择CSV文件');
                    this.value = '';
                    return;
                }
                // 显示选中的文件名
                const status = document.getElementById('upload-status');
                status.textContent = `已选择文件：${file.name}`;
            }
        });

        // 格式化日期时间
        function formatDateTime(date) {
            if (!date) return '-';
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 加载用户列表
        function loadUserList() {
            fetch('/api/users/')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const userList = document.getElementById('user-list');
                        userList.innerHTML = '';
                        
                        data.data.forEach(user => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.username}</td>
                                <td>${user.email || '-'}</td>
                                <td>${formatDateTime(new Date(user.date_joined))}</td>
                                <td>${user.last_login ? formatDateTime(new Date(user.last_login)) : '从未登录'}</td>
                                <td>
                                    <button class="action-btn edit-btn" onclick="editUser('${user.id}')">编辑</button>
                                    <button class="action-btn delete-btn" onclick="deleteUser('${user.id}')">删除</button>
                                </td>
                            `;
                            userList.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载用户列表失败:', error);
                    alert('加载用户列表失败，请稍后重试');
                });
        }

        // 刷新用户列表
        function refreshUserList() {
            loadUserList();
        }

        // 编辑用户
        function editUser(userId) {
            // TODO: 实现编辑用户功能
            alert('编辑用户功能开发中...');
        }

        // 删除用户
        function deleteUser(userId) {
            if (confirm('确定要删除该用户吗？此操作不可恢复！')) {
                fetch(`/api/users/${userId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('用户删除成功');
                        loadUserList();
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('删除用户失败:', error);
                    alert('删除用户失败，请稍后重试');
                });
            }
        }

        // 获取CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 加载地块列表
        function loadFieldList() {
            fetch('/api/fields/')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const fieldList = document.getElementById('field-list');
                        fieldList.innerHTML = '';
                        
                        data.data.forEach(field => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${field.file_name}</td>
                                <td>${field.track_count || 0}</td>
                                <td>
                                    <button class="action-btn delete-btn" onclick="deleteField('${field.file_name}')">删除</button>
                                </td>
                            `;
                            fieldList.appendChild(row);
                        });
                    }
                })
                .catch(error => {
                    console.error('加载地块列表失败:', error);
                    alert('加载地块列表失败，请稍后重试');
                });
        }

        // 刷新地块列表
        function refreshFieldList() {
            loadFieldList();
        }

        // 删除地块
        function deleteField(fieldName) {
            if (confirm('确定要删除该地块吗？此操作将同时删除该地块的所有轨迹数据，且不可恢复！')) {
                fetch(`/api/fields/${fieldName}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('地块删除成功');
                        loadFieldList();
                        // 刷新统计数据
                        location.reload();
                    } else {
                        alert('删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    console.error('删除地块失败:', error);
                    alert('删除地块失败，请稍后重试');
                });
            }
        }

        // 页面加载完成后加载用户列表和地块列表
        document.addEventListener('DOMContentLoaded', function() {
            loadUserList();
            loadFieldList();
        });
    </script>
</body>
</html> 